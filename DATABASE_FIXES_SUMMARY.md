# Database Schema Fixes - Summary

## ✅ Fixed Issues

### 1. User Service Schema (`mediapp_user` database)
**File**: `user-service/src/main/resources/db/V1__create_user_schema.sql`

**Changes Made**:
- ✅ Changed `user_id` from `BINARY(16)` to `BIGINT AUTO_INCREMENT`
- ✅ Added `auth_user_id BIGINT NOT NULL UNIQUE` column (links to security-service)
- ✅ Removed `password_hash` column (belongs in security-service only)
- ✅ Fixed `patient_profile.patient_id` to use shared ID pattern (no AUTO_INCREMENT)
- ✅ Added indexes for performance

**Before**:
```sql
user_id BINARY(16) PRIMARY KEY,
email VARCHAR(100) NOT NULL UNIQUE,
password_hash VARCHAR(255) NOT NULL,  -- ❌ Wrong service!
-- ❌ Missing auth_user_id!
```

**After**:
```sql
user_id BIGINT AUTO_INCREMENT PRIMARY KEY,
auth_user_id BIGINT NOT NULL UNIQUE,  -- ✅ Links to security-service
email VARCHAR(100) NOT NULL UNIQUE,
-- ✅ No password storage here
```

---

### 2. Doctor Service Schema (`mediapp_doctor` database)
**Files**: 
- `doctor-service/src/main/resources/db/schema.sql`
- `doctor-service/src/main/resources/db/migration/V1__init_schema.sql`

**Changes Made**:
- ✅ Changed `doctor_id` from `CHAR(36)` to `BIGINT AUTO_INCREMENT`
- ✅ Added `user_id BIGINT NOT NULL UNIQUE` column (links to user-service)
- ✅ Changed `slot_id` from `CHAR(36)` to `BIGINT AUTO_INCREMENT`
- ✅ Added indexes for performance

**Before**:
```sql
doctor_id CHAR(36) PRIMARY KEY,  -- ❌ UUID string, incompatible with Long
-- ❌ Missing user_id!
```

**After**:
```sql
doctor_id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- ✅ Matches Long type
user_id BIGINT NOT NULL UNIQUE,  -- ✅ Links to user-service
```

---

### 3. Booking Service
**Status**: ✅ Already correct!

The `Appointment` entity already uses:
```java
@Column(name = "patient_id", nullable = false)
private Long patientId;

@Column(name = "doctor_id", nullable = false)
private Long doctorId;

@Column(name = "slot_id", nullable = false, unique = true)
private Long slotId;
```

No schema fixes needed - entities match expected schema.

---

## ID Strategy Summary

All services now use **Long (BIGINT AUTO_INCREMENT)** consistently:

| Service | Table | ID Column | Type | Notes |
|---------|-------|-----------|------|-------|
| **security-service** | `app_users` | `id` | `BIGINT` | Auto-generated by JPA |
| **user-service** | `app_user` | `user_id` | `BIGINT` | Auto-increment |
| **user-service** | `app_user` | `auth_user_id` | `BIGINT` | FK to security-service.id |
| **user-service** | `patient_profile` | `patient_id` | `BIGINT` | Shared with user_id (@MapsId) |
| **doctor-service** | `doctor_profile` | `doctor_id` | `BIGINT` | Auto-increment |
| **doctor-service** | `doctor_profile` | `user_id` | `BIGINT` | FK to user-service.user_id |
| **doctor-service** | `availability_slot` | `slot_id` | `BIGINT` | Auto-increment |
| **booking-service** | `appointment` | `appointment_id` | `BIGINT` | Auto-increment |

---

## Cross-Service Relationships

```
┌─────────────────────┐
│ security-service    │
│   app_users         │
│   └─ id (BIGINT)    │ ◄──┐
└─────────────────────┘    │
                           │ FK: auth_user_id
                           │
┌─────────────────────┐    │
│ user-service        │    │
│   app_user          │    │
│   ├─ user_id        │    │
│   └─ auth_user_id ──┼────┘
│                     │
│   patient_profile   │ ◄──┐
│   └─ patient_id ────┼────┤ @MapsId (shares user_id)
└─────────────────────┘    │
                           │
┌─────────────────────┐    │
│ doctor-service      │    │
│   doctor_profile    │    │
│   ├─ doctor_id      │    │
│   └─ user_id ───────┼────┘ FK: to user-service.user_id
│                     │
│   availability_slot │ ◄──┐
│   └─ slot_id        │    │
└─────────────────────┘    │
                           │
┌─────────────────────┐    │
│ booking-service     │    │
│   appointment       │    │
│   ├─ appointment_id │    │
│   ├─ patient_id ────┼────┘ Logical FK
│   ├─ doctor_id      │
│   └─ slot_id ───────┼────┘ FK: to availability_slot.slot_id
└─────────────────────┘
```

---

## Issues Resolved

| Original Issue | Status | Solution |
|---------------|--------|----------|
| ❌ Mismatched emails | ✅ **FIXED** | All services can now share email via consistent IDs |
| ❌ Inconsistent password storage | ✅ **FIXED** | Removed password from user-service schema |
| ❌ Different user IDs | ✅ **FIXED** | All services use BIGINT/Long consistently |
| ❌ Impossible sync | ✅ **FIXED** | Added `auth_user_id` and `user_id` foreign keys |
| ❌ Login working but profile failing | ✅ **FIXED** | IDs now compatible across services |
| ❌ Registration needing double inserts | ⚠️ **PARTIALLY FIXED** | IDs fixed, but still needs saga pattern |

---

## ⚠️ IMPORTANT: Next Steps Required

### 1. Drop and Recreate Databases

Since schema structure changed significantly, you need to:

```bash
# Connect to MySQL
mysql -u root -p

# Drop existing databases
DROP DATABASE IF EXISTS mediapp_user;
DROP DATABASE IF EXISTS mediapp_security;
DROP DATABASE IF EXISTS mediapp_doctor;
DROP DATABASE IF EXISTS mediapp_booking;

# Exit MySQL - let the apps recreate them
exit
```

The applications will recreate the databases with correct schemas on next startup (due to `createDatabaseIfNotExist=true`).

### 2. Consider Disabling `ddl-auto=update`

Current config in all services:
```properties
spring.jpa.hibernate.ddl-auto=update
```

**Recommendation**: Change to `validate` after initial setup:
```properties
spring.jpa.hibernate.ddl-auto=validate
```

This ensures schema files are the source of truth, not Hibernate's auto-generation.

### 3. Still Need: Distributed Transaction Handling

The cross-service registration flow still has no transactional boundary:
1. Security-service creates auth user
2. User-service creates profile 
3. Doctor-service creates doctor profile

**If step 2 or 3 fails**, you'll have orphaned records.

**Solutions to consider**:
- Saga pattern with compensating transactions
- Outbox pattern with eventual consistency
- Two-phase commit (2PC)

---

## Testing the Fixes

1. **Stop all services**
2. **Drop databases** (see commands above)
3. **Start services** in order:
   - discovery-server
   - security-service
   - user-service
   - doctor-service
   - booking-service
   - gateway-service
4. **Test patient registration**
5. **Test doctor registration**
6. **Check all databases have correct schemas**
